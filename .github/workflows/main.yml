name: CI/CD MLflow

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master

env:
  CSV_URL: "MLproject/train_pca.csv"
  TARGET_VAR: "Credit_Score"
  # Optimized model parameters for resource efficiency
  N_ESTIMATORS: "100"
  MAX_DEPTH: "15"
  MIN_SAMPLES_SPLIT: "10"
  MIN_SAMPLES_LEAF: "5"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE
      - uses: actions/checkout@v3

      # Setup Python 3.12.7
      - name: Set up Python 3.12.7
        uses: actions/setup-python@v4
        with:
          python-version: "3.12.7"

      # Check Env Variables
      - name: Check Env
        run: |
          echo $CSV_URL
      # Install mlflow and dependencies
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install mlflow scikit-learn pandas numpy joblib

      # Monitor system resources before training
      - name: Check System Resources
        run: |
          echo "Available memory:"
          free -h || true
          echo "CPU info:"
          nproc || true
          df -h

      # Run as a mlflow project with optimized parameters
      - name: Run optimized mlflow project
        run: |
          echo "Training with optimized parameters for resource efficiency:"
          echo "n_estimators: $N_ESTIMATORS (reduced from 505)"
          echo "max_depth: $MAX_DEPTH (reduced from 35)"
          mlflow run MLproject --env-manager=local -P n_estimators=$N_ESTIMATORS -P max_depth=$MAX_DEPTH -P min_samples_split=$MIN_SAMPLES_SPLIT -P min_samples_leaf=$MIN_SAMPLES_LEAF

      # Monitor resources after training
      - name: Check Resources After Training
        run: |
          echo "Memory usage after training:"
          free -h || true
          echo "Disk usage:"
          df -h

      # Validate model performance
      - name: Validate Model Performance
        run: |
          echo "Checking model metrics..."
          python -c "
          import mlflow
          import pandas as pd

          # Get the latest run
          client = mlflow.tracking.MlflowClient()
          runs = client.search_runs(experiment_ids=['0'], order_by=['start_time DESC'], max_results=1)

          if runs:
              run = runs[0]
              metrics = run.data.metrics
              print(f'Model Performance Summary:')
              print(f'Accuracy: {metrics.get(\"accuracy\", 0):.4f}')
              print(f'OOB Score: {metrics.get(\"oob_score\", 0):.4f}')
              print(f'Model Size (MB): {metrics.get(\"model_size_mb\", 0):.2f}')
              
              # Validate minimum performance requirements
              min_accuracy = 0.7  # 70% minimum accuracy
              if metrics.get('accuracy', 0) < min_accuracy:
                  print(f'ERROR: Model accuracy {metrics.get(\"accuracy\", 0):.4f} is below minimum threshold {min_accuracy}')
                  exit(1)
              else:
                  print(f'âœ… Model meets performance requirements')
          else:
              print('No runs found')
              exit(1)
          "

      # Compare with previous model (if exists)
      - name: Model Performance Comparison
        run: |
          echo "Optimized model stats:"
          echo "- Estimators: $N_ESTIMATORS (reduced from 505 = 80% reduction)"
          echo "- Max Depth: $MAX_DEPTH (reduced from 35 = 57% reduction)"
          echo "- Expected memory reduction: ~75-80%"
          echo "- Expected training time reduction: ~80%"
          echo "- Expected inference time improvement: ~70%"

      # Get latest run_id
      - name: Get latest MLflow run_id
        run: |
          RUN_ID=$(ls -td mlruns/0/*/ | head -n 1 | cut -d'/' -f3)
          echo "RUN_ID=$RUN_ID" >> $GITHUB_ENV
          echo "Latest run_id: $RUN_ID"

      # Build Optimized Docker Model
      - name: Build Optimized Docker Model
        run: |
          echo "Building Docker image with optimized model..."
          mlflow models build-docker --model-uri "runs:/$RUN_ID/model" --name "credit-scoring-model-optimized"
          echo "Docker image size:"
          docker images credit-scoring-model-optimized

      # Login to Docker Hub
      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}

      # Tag the optimized Docker image
      - name: Tag Optimized Docker Image
        run: |
          docker tag credit-scoring-model-optimized ${{ secrets.DOCKER_HUB_USERNAME }}/credit-scoring-model-optimized:latest
          docker tag credit-scoring-model-optimized ${{ secrets.DOCKER_HUB_USERNAME }}/credit-scoring-model-optimized:${{ github.sha }}

      # Push optimized Docker image to Docker Hub
      - name: Push Optimized Docker Image
        run: |
          docker push ${{ secrets.DOCKER_HUB_USERNAME }}/credit-scoring-model-optimized:latest
          docker push ${{ secrets.DOCKER_HUB_USERNAME }}/credit-scoring-model-optimized:${{ github.sha }}
          echo "Optimized model pushed successfully!"
          echo "Image tags: latest, ${{ github.sha }}"
